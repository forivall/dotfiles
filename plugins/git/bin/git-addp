#!/usr/bin/env zsh

set -eo pipefail

__plugin_dirname=${0:a:h:h}

local configArgs=()

__git-addp-hasfiles() {
  ! git diff-files --quiet $@ ||
  ! git ls-files --other --exclude-standard $@ | sed q1 > /dev/null
}
__git-addp-getitems() {
  git diff --name-only $@
  git ls-files --other --exclude-standard $@
}
__git-addp-dointeractive() {
  if git ls-files --error-unmatch $@ 2> /dev/null; then
    git "${configArgs[@]}" add -p $@
  else
    git "${configArgs[@]}" add $@
    local display_cmd=(git "${configArgs[@]}" diff --cached $@)
    local diff_filter=$(git config interactive.diffFilter)
    if [[ -n $diff_filter ]]; then
      $display_cmd | eval $diff_filter
    else
      $display_cmd
    fi
    echo Added $@
  fi
}
source $__plugin_dirname/__git-patch-filepicker \
  __git-addp-{hasfiles,getitems,dointeractive} $@

echo 'Nothing left to stage'
