#!/usr/bin/env zsh

# set -euo pipefail

__plugin_dirname=${0:a:h:h}

autoload -U colors  && colors

OPTS_SPEC="\
git checkout-recent [<options>] <args>...
--
h,help      show the help
n,count=    show this many commits [default=10]
"
eval "$(echo "$OPTS_SPEC" | git rev-parse --parseopt --stuck-long -- "$@" || echo exit $?)"

NUM=10

index=0
for arg in $@; do
  index=$((index+1))
  case "$arg" in
    --count=*) NUM="${arg#--count=}" ;;
    --) break ;;
  esac
done

entries=()
branches=()

_i=0
(for i in {1..99} ; do
  branchname=$(git rev-parse --symbolic-full-name @{-$i} 2>/dev/null)
  if [[ $branchname == "@{-$i}" || -z "$branchname" ]] ; then continue; fi
  # printf '%-7s ' @{-$i}
  echo @{-$i} ${branchname#refs/heads/}
done) | awk '!x[$2]++' | while read -A entry ; do
  entries+=("${entry[1]} ${entry[2]}|${entry[1]}")
  branches+=(${entry[1]})
  _i=$(( $_i + 1 ))
  if (( $_i >= $NUM )) ; then break; fi
done

term_menu_options=(
  --no-preview-border
  --preview-size 0.6
  --preview "$__plugin_dirname/__git-checkoutb-preview {}"
)

simple-term-menu $term_menu_options "${entries[@]}" && i=0 || i=$?
if (( $i == 0 )) ; then exit; fi

branch=${branches[i]}
echo '>' git checkout $branch
git checkout $branch
