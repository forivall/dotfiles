#!/usr/bin/env zsh

set -eo pipefail

__plugin_dirname=${0:a:h:h}

local configArgs=()
local revs=(${(f)$(git rev-parse --revs-only $@)})
if (( ${#revs} == 0 )); then
  revs+=(HEAD)
fi
local cdup=$(git rev-parse --show-cdup)

__git-checkoutp-hasfiles() {
  items=(
    $(git diff --name-only $@)
  )
  if (( $# == 0 )); then
    items+=(
      $(git ls-files --full-name --other --directory --no-empty-directory --exclude-standard $@)
    )
  fi
  (( ${#items} > 0 ))
}
__git-checkoutp-getitems_vars() {
  term_menu_options=(--no-preview-border --preview "$__plugin_dirname/__git-addp-preview $cdup{} ${#items} $revs")
}
__git-checkoutp-dointeractive() {
  git "${configArgs[@]}" checkout -p $@
}
source $__plugin_dirname/__git-patch-filepicker \
  __git-checkoutp-{hasfiles,getitems_vars,dointeractive} $@

echo 'No changes left to discard'
